image: docker:20.10.16

services:
  - name: docker:dind
    command: ["--tls=false"]
    privileged: true  # Ajoute cette ligne !


variables:
  DOCKER_TLS_CERTDIR: ""  # D√©sactive le TLS qui bloque Docker-in-Docker
  DOCKER_HOST: tcp://docker:2375/
  CI_REGISTRY: "wvm-srv7.luminy.univ-amu.fr:5050"
  BACKEND_IMAGE: "$CI_REGISTRY/spoofy/secure_directory_backend"
  FRONTEND_IMAGE: "$CI_REGISTRY/spoofy/secure_directory_frontend"


stages:
  - test
  - build
  - push
  - deploy

before_script:
  - echo "Connexion √† la registry GitLab..."
  - docker login $CI_REGISTRY -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD"
  - mkdir -p ~/.ssh
  - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
  - chmod 600 ~/.ssh/id_ed25519
  - eval $(ssh-agent -s)
  - ssh-add ~/.ssh/id_ed25519
  - ssh-keyscan 139.124.86.159 >> ~/.ssh/known_hosts


# √âtape 1: Test Backend
test-backend:
  image: docker:latest
  stage: test
  script:
    - apk add --no-cache maven openjdk17  # Installe Maven et Java
    - echo "üîç Ex√©cution des tests backend..."
    - cd backend
    - mvn test
  only:
    - main  # Change 'main' selon votre branche principale

# √âtape 2: Build Backend
build-backend:
  image: docker:latest
  stage: build
  script:
    - apk add --no-cache maven openjdk17  # Installe Maven et Java
    - echo "Compilation du backend..."
    - cd backend
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar
  only:
    - main

# √âtape 3: Build Docker Image Backend
docker-build-backend:
  stage: build
  script:
    - echo "Construction de l'image Docker backend..."
    - cd backend
    - docker build -t $BACKEND_IMAGE .
  only:
    - main

# √âtape 4: Push Docker Image Backend
docker-push-backend:
  stage: push
  script:
    - echo " Pushing de l'image Docker backend..."
    - docker push $BACKEND_IMAGE
  only:
    - main

# √âtape 5: Build Docker Image Frontend
docker-build-frontend:
  stage: build
  script:
    - echo "Construction de l'image Docker frontend..."
    - cd frontend
    - docker build -t $FRONTEND_IMAGE .
  only:
    - main

# √âtape 6: Push Docker Image Frontend
docker-push-frontend:
  stage: push
  script:
    - echo "Pushing de l'image Docker frontend..."
    - docker push $FRONTEND_IMAGE
  only:
    - main

# √âtape 7: D√©ploiement sur la VM
deploy:
  stage: deploy
  script:
    - apk add --no-cache maven openjdk17  # Installe Maven et Java
    - echo "D√©ploiement en cours sur la VM..."
    - ssh projet@139.124.86.159 "mkdir -p ~/secure_directory"
    - scp backend/target/*.jar projet@139.124.86.159:~/secure_directory/backend.jar
    - scp -r frontend/dist/* projet@139.124.86.159:~/secure_directory/frontend
    - ssh projet@139.124.86.159 "chmod +x ~/secure_directory/deploy.sh && bash ~/secure_directory/deploy.sh"
  only:
    - main
